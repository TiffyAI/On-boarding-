<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8"/>
Â  <title>TiffyAI Claim & Withdraw</title>
Â  <meta name="viewport" content="width=device-width,initial-scale=1"/>
Â  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
Â  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
Â  <style>
Â  Â  *{margin:0;padding:0;box-sizing:border-box}
Â  Â  html,body{width:100%;height:100%;font-family:'Segoe UI',sans-serif;overflow:hidden;background:#000;color:#0ff}
Â  Â  #loadingScreen,#mainPortal{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;}
Â  Â  #loadingScreen{background:url('https://tiffyai.github.io/Blue-Key-Claim/lot6.jpg') no-repeat center center/cover;}
Â  Â  #typingText{font-size:24px;text-align:center;text-shadow:0 0 10px #0ff;margin:20px}
Â  Â  #connectBtn{margin-top:20px;padding:12px 30px;font-size:18px;border:none;border-radius:10px;background:linear-gradient(to right,#00f0ff,#4b6cb7);color:#fff;cursor:pointer;box-shadow:0 0 20px #0ff}
Â  Â  #mainPortal{display:none;background:url('TiffyAI -Treasury.jpg') center/cover}
Â  Â  .card{background:rgba(0,0,0,0.6);padding:20px;border:1px solid #0ff;border-radius:12px;text-align:center;max-width:400px;box-shadow:0 0 20px #0ff}
Â  Â  .card img{height:32px;vertical-align:middle;margin-right:8px}
Â  Â  .btn{margin-top:20px;padding:12px 25px;font-size:16px;border:none;border-radius:8px;cursor:pointer}
Â  Â  .withdraw{background:gold;color:#000;box-shadow:0 0 15px #ff0}
Â  Â  .claim{background:#4af0f8;color:#000;box-shadow:0 0 15px #0ff}
Â  Â  a.sourcify{display:block;color:#0ff;text-decoration:none;margin-top:15px;font-size:14px}
Â  Â  a.sourcify:hover{text-decoration:underline}

    /* New styles for the wallet display below the buttons */
    .wallet-info {
        display: flex;
        justify-content: space-around;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid rgba(74, 240, 248, 0.5);
    }
    .wallet-info .balance-group, .wallet-info .price-group {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .wallet-info img {
        height: 40px;
        width: 40px;
        margin-bottom: 5px;
    }
    .wallet-info .balance-text, .wallet-info .price-text {
        font-size: 1.1em;
        font-weight: bold;
    }
    .wallet-info .usd-value {
        color: #ffcc00;
        font-size: 1em;
    }
    
Â  Â  /* Modal styles from index (1).html */
Â  Â  #feeModal {
Â  Â  Â  position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
Â  Â  Â  background: rgba(0,0,0,0.95); border: 2px solid #0ff; padding: 18px; border-radius: 10px; color: #0ff;
Â  Â  Â  display: none; z-index: 2000; width: 90%; max-width: 420px; text-align: left; box-shadow: 0 0 30px rgba(0,255,255,0.08);
Â  Â  }
Â  Â  #feeModal h3 { margin-top:0; text-align:center; }
Â  Â  #feeModal .row { display:flex; justify-content:space-between; margin:8px 0; }
Â  Â  #feeModal .actions { display:flex; justify-content:space-between; gap:10px; margin-top:12px; }
Â  Â  #feeModal button { flex:1; padding:10px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; }
Â  Â  #feeModal .cancel { background:#222; color:#fff; border:1px solid #444; }
Â  Â  #feeModal .confirm { background:linear-gradient(90deg,#00ffcc,#00aaff); color:#000; }
Â  Â  .badge { display:inline-block; padding:4px 8px; border-radius:8px; background:rgba(255,255,255,0.05); color:#0ff; font-weight:bold; }
Â  </style>
</head>
<body>
Â  <div id="loadingScreen">
Â  Â  <div id="typingText"></div>
Â  Â  <button id="connectBtn">Connect Wallet</button>
Â  </div>

Â  <div id="mainPortal">
Â  Â  <div class="card">
Â  Â  Â  <div><strong>ğŸ’¼ Connected:</strong> <span id="walletAddress"></span></div>

      Â  Â  Â  <a href="https://repo.sourcify.dev/56/0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5" target="_blank" class="sourcify">ğŸ§ª Verified on Sourcify</a>

Â  Â  Â  <button class="btn withdraw" id="withdrawBtn" style="display:none">Withdraw My TIFFY</button>
Â  Â  Â  <button class="btn claim" id="claimBtn" style="display:none">Claim 1 TIFFY</button>
Â  Â  Â  <div id="cooldownTimer" style="margin-top:12px;font-size:18px;text-shadow:0 0 10px #0ff,0 0 20px #f0f;font-weight:bold;"></div>

      <div class="wallet-info">
        <div class="balance-group">
          <img src="https://tiffyai.github.io/Blue-Key-Claim/TiffyAI-Token.png" alt="TIFFY"/>
          <strong class="balance-text" id="tiffyCount">0 TIFFY</strong>
        </div>
        <div class="price-group">
          <span class="price-text">Price: $<span id="livePrice">â€“</span></span>
          <span class="usd-value" id="usdValue">USD: $0.00</span>
        </div>
      </div>

Â  Â  </div>
Â  </div>

Â  <div id="feeModal" role="dialog" aria-modal="true">
Â  Â  <h3>Confirm Withdrawal</h3>
Â  Â  <div class="row"><div class="badge">Accumulated</div><div id="modalTiffy">- TIFFY</div></div>
Â  Â  <div class="row"><div>TIFFY USD</div><div id="modalTiffyUSD">-</div></div>
Â  Â  <div class="row"><div>TIFFY in BNB</div><div id="modalTiffyBNB">- BNB</div></div>
Â  Â  <hr style="border:0;border-top:1px solid rgba(0,255,255,0.06);margin:8px 0;">
Â  Â  <div class="row"><div>Contract fee</div><div id="modalContractFee">- BNB</div></div>
Â  Â  <div class="row"><div>Estimated network fee</div><div id="modalGasFee">- BNB</div></div>
Â  Â  <div class="row"><div><strong>Total estimate</strong></div><div id="modalTotal">- BNB</div></div>
Â  Â  <div class="row"><div>Approx USD</div><div id="modalUSD">-</div></div>
Â  Â  <div style="font-size:12px;margin-top:8px;color:#aaffff;">This is an estimate. Wallet will show final gas before you confirm.</div>
Â  Â  <div class="actions">
Â  Â  Â  <button class="cancel" id="feeCancel">Cancel</button>
Â  Â  Â  <button class="confirm" id="feeConfirm">Proceed</button>
Â  Â  </div>
Â  </div>

Â  <audio id="claimSound" src="single-coin.wav" preload="auto"></audio>
Â  <audio id="withdrawSound" src="withdraw.wav" preload="auto"></audio>

Â  <script>
Â  (async ()=>{
Â  Â  const cAddr = "0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5";
Â  Â  const ABI = [
Â  Â  Â  {inputs:[],name:"claim",outputs:[],stateMutability:"payable",type:"function"},
Â  Â  Â  {inputs:[],name:"FIXED_BNB_FEE",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},
Â  Â  Â  {inputs:[{internalType:"address",name:"",type:"address"}],name:"lastClaimed",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"}
Â  Â  ];
Â  Â  const BACKEND = "https://tiffyai-wh-wa.onrender.com/reward";
Â  Â  const PRICE_JSON_PATH = "/TIFFY-Market-Value/price.json";
Â  Â  let web3, provider, account, contract, fee;

Â  Â  const E = {
Â  Â  Â  type: document.getElementById("typingText"),
Â  Â  Â  connect: document.getElementById("connectBtn"),
Â  Â  Â  load: document.getElementById("loadingScreen"),
Â  Â  Â  portal: document.getElementById("mainPortal"),
Â  Â  Â  wallet: document.getElementById("walletAddress"),
Â  Â  Â  count: document.getElementById("tiffyCount"),
Â  Â  Â  usd: document.getElementById("usdValue"),
Â  Â  Â  live: document.getElementById("livePrice"),
Â  Â  Â  withdraw: document.getElementById("withdrawBtn"),
Â  Â  Â  claim: document.getElementById("claimBtn"),
Â  Â  Â  claimSound: document.getElementById("claimSound"),
Â  Â  Â  withdrawSound: document.getElementById("withdrawSound"),
Â  Â  Â  cooldown: document.getElementById("cooldownTimer")
Â  Â  };

Â  Â  // Modal elements
Â  Â  const feeModal = document.getElementById("feeModal");
Â  Â  const modalTiffy = document.getElementById("modalTiffy");
Â  Â  const modalTiffyUSD = document.getElementById("modalTiffyUSD");
Â  Â  const modalTiffyBNB = document.getElementById("modalTiffyBNB");
Â  Â  const modalContractFee = document.getElementById("modalContractFee");
Â  Â  const modalGasFee = document.getElementById("modalGasFee");
Â  Â  const modalTotal = document.getElementById("modalTotal");
Â  Â  const modalUSD = document.getElementById("modalUSD");
Â  Â  const feeCancel = document.getElementById("feeCancel");
Â  Â  const feeConfirm = document.getElementById("feeConfirm");

Â  Â  function typeChars(str,i=0){
Â  Â  Â  if(i<str.length) setTimeout(()=>{E.type.textContent+=str[i]; typeChars(str,i+1);},40);
Â  Â  }
Â  Â  typeChars("You are eligible to claim TIFFY every 10 min. Connect your wallet to view, claim or withdraw your claimed TIFFY.");

Â  Â  const wModal = new Web3Modal.default({ cacheProvider:false, providerOptions:{ walletconnect:{ package:window.WalletConnectProvider?.default||{}, options:{ rpc:{56:"https://bsc-dataseed.binance.org/"}}}}});

Â  Â  E.connect.onclick = async() => {
Â  Â  Â  try {
Â  Â  Â  Â  provider = await wModal.connect();
Â  Â  Â  Â  web3 = new Web3(provider);
Â  Â  Â  Â  const cid = await web3.eth.getChainId();

Â  Â  Â  Â  if(cid !== 56){
Â  Â  Â  Â  Â  try { await provider.request({ method:"wallet_switchEthereumChain", params:[{chainId:"0x38"}] }); }
Â  Â  Â  Â  Â  catch(e){
Â  Â  Â  Â  Â  Â  if(provider.isBitget || provider.isBitKeep){
Â  Â  Â  Â  Â  Â  Â  try { await provider.request({ method:"wallet_addEthereumChain", params:[{chainId:"0x38",chainName:"BNB Smart Chain",rpcUrls:["https://bsc-dataseed.binance.org/"],nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},blockExplorerUrls:["https://bscscan.com"]}]});}
Â  Â  Â  Â  Â  Â  Â  catch{alert("ğŸŒ Bitget: please switch BSC manually."); return;}
Â  Â  Â  Â  Â  Â  } else { alert("â— Please switch to BNB Smart Chain"); return; }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const accts = await web3.eth.getAccounts();
Â  Â  Â  Â  account = accts[0];
Â  Â  Â  Â  contract = new web3.eth.Contract(ABI, cAddr);
Â  Â  Â  Â  fee = await contract.methods.FIXED_BNB_FEE().call();

Â  Â  Â  Â  E.wallet.textContent = account;
Â  Â  Â  Â  E.load.style.display = "none";
Â  Â  Â  Â  E.portal.style.display = "flex";

Â  Â  Â  Â  setupUI();
Â  Â  Â  Â  fetchPrice();
Â  Â  Â  Â  setInterval(fetchPrice,60000);
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  alert("âŒ Wallet connection failed: " + (err && err.message ? err.message : err));
Â  Â  Â  }
Â  Â  };

Â  Â  function setupUI(){
Â  Â  Â  const key = `tiffyClaimed_${account}`;
Â  Â  Â  const lastKey = `lastClaimTime_${account}`;
Â  Â  Â  let cnt = parseInt(localStorage.getItem(key)||"0");
Â  Â  Â  E.withdraw.style.display = cnt > 0 ? "inline-block" : "none";
Â  Â  Â  E.claim.style.display = "inline-block";
Â  Â  Â  updateDisplay(cnt);

Â  Â  Â  function updateTimer() {
Â  Â  Â  Â  const last = parseInt(localStorage.getItem(lastKey) || "0");
Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  const diff = now - last;
Â  Â  Â  Â  const cooldownMs = 10 * 60 * 1000; // 10 minutes
Â  Â  Â  Â  const remain = cooldownMs - diff;
Â  Â  Â  Â  if (remain > 0) {
Â  Â  Â  Â  Â  const m = String(Math.floor(remain / 60000)).padStart(2,"0");
Â  Â  Â  Â  Â  const s = String(Math.floor((remain % 60000) / 1000)).padStart(2,"0");
Â  Â  Â  Â  Â  E.cooldown.textContent = `â³ Cooldown: ${m}:${s}`;
Â  Â  Â  Â  Â  E.claim.disabled = true;
Â  Â  Â  Â  Â  E.claim.textContent = "ON COOLDOWN";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  E.cooldown.textContent = "âœ… Ready to claim!";
Â  Â  Â  Â  Â  E.claim.disabled = false;
Â  Â  Â  Â  Â  E.claim.textContent = "Claim 1 TIFFY";
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  updateTimer();
Â  Â  Â  clearInterval(window.cooldownInterval);
Â  Â  Â  window.cooldownInterval = setInterval(updateTimer, 1000);

Â  Â  Â  E.claim.onclick = ()=> {
Â  Â  Â  Â  const last = parseInt(localStorage.getItem(lastKey) || "0");
Â  Â  Â  Â  if (Date.now() - last < 10 * 60 * 1000) return; // still cooling down
Â  Â  Â  Â  cnt = cnt+1;
Â  Â  Â  Â  localStorage.setItem(key,cnt);
Â  Â  Â  Â  localStorage.setItem(lastKey, Date.now());
Â  Â  Â  Â  updateDisplay(cnt);
Â  Â  Â  Â  E.claimSound.play();
Â  Â  Â  Â  updateTimer();
Â  Â  Â  };

Â  Â  Â  E.withdraw.onclick = withdraw;
Â  Â  }

Â  Â  function updateDisplay(cnt){
Â  Â  Â  E.count.textContent = `${cnt} TIFFY`;
Â  Â  Â  const price = parseFloat(E.live.textContent || 0);
Â  Â  Â  E.usd.textContent = `USD: $${(cnt * price).toFixed(2)}`;
Â  Â  Â  if (contract && account) {
Â  Â  Â  Â  contract.methods.lastClaimed(account).call().then(last => {
Â  Â  Â  Â  Â  const now = Math.floor(Date.now() / 1000);
Â  Â  Â  Â  Â  const ready = now >= parseInt(last || 0) + 86400; // 24 hours
Â  Â  Â  Â  Â  E.withdraw.disabled = !ready || cnt <= 0;
Â  Â  Â  Â  Â  if (!ready) E.withdraw.textContent = "ON COOLDOWN";
Â  Â  Â  Â  Â  else E.withdraw.textContent = "WITHDRAW";
Â  Â  Â  Â  }).catch(()=>{});
Â  Â  Â  }
Â  Â  }

Â  Â  async function fetchPrice(){
Â  Â  Â  try {
Â  Â  Â  Â  const r = await fetch(PRICE_JSON_PATH);
Â  Â  Â  Â  const d = await r.json();
Â  Â  Â  Â  E.live.textContent = parseFloat(d.tiffyToUSD).toFixed(2);
Â  Â  Â  Â  const cnt = parseInt(localStorage.getItem(`tiffyClaimed_${account}`)||"0");
Â  Â  Â  Â  updateDisplay(cnt);
Â  Â  Â  } catch(e){
Â  Â  Â  Â  E.live.textContent = "-";
Â  Â  Â  }
Â  Â  }

Â  Â  function getAccumulatedTiffy(addr) {
Â  Â  Â  const key = `tiffyClaimed_${addr}`;
Â  Â  Â  return parseInt(localStorage.getItem(key) || "0");
Â  Â  }

Â  Â  async function fetchTiffyPriceUSD() {
Â  Â  Â  try {
Â  Â  Â  Â  const resp = await fetch(PRICE_JSON_PATH, {cache:'no-store'});
Â  Â  Â  Â  const data = await resp.json();
Â  Â  Â  Â  const price = parseFloat(data.tiffyToUSD);
Â  Â  Â  Â  if (!isNaN(price)) return price;
Â  Â  Â  } catch (e) { }
Â  Â  Â  return null;
Â  Â  }

Â  Â  async function fetchBNBPriceUSD() {
Â  Â  Â  try {
Â  Â  Â  Â  const resp = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd");
Â  Â  Â  Â  const data = await resp.json();
Â  Â  Â  Â  return parseFloat(data.binancecoin.usd);
Â  Â  Â  } catch (e) { return null; }
Â  Â  }

Â  Â  async function preConfirmAndSend() {
Â  Â  Â  if (!account || !contract) { alert("Connect wallet first."); return false; }
Â  Â  Â Â 
Â  Â  Â  const accumulated = getAccumulatedTiffy(account) || 0;
Â  Â  Â  if (accumulated <= 0) { alert("You have no TIFFY to withdraw."); return false; }

Â  Â  Â  try { fee = await contract.methods.FIXED_BNB_FEE().call(); } catch(e){ fee = null; }

Â  Â  Â  let estimatedGas = 150000;
Â  Â  Â  let gasPrice = await web3.eth.getGasPrice().catch(()=>null);
Â  Â  Â  try {
Â  Â  Â  Â  estimatedGas = await contract.methods.claim().estimateGas({ from: account, value: fee || 0 });
Â  Â  Â  } catch (err) {}
Â  Â  Â  if(!gasPrice) gasPrice = "20000000000";Â 

Â  Â  Â  const gasBNIWei = BigInt(estimatedGas) * BigInt(gasPrice);
Â  Â  Â  const gasBNB = parseFloat(web3.utils.fromWei(gasBNIWei.toString(), "ether"));
Â  Â  Â  const feeBNB = fee ? parseFloat(web3.utils.fromWei(fee.toString(), "ether")) : 0;
Â  Â  Â  const totalBNB = feeBNB + gasBNB;

Â  Â  Â  const tiffyUSD = await fetchTiffyPriceUSD();
Â  Â  Â  const bnbUSD = await fetchBNBPriceUSD();
Â  Â  Â  const tiffyUsdVal = tiffyUSD ? (accumulated * tiffyUSD) : null;
Â  Â  Â  const tiffyInBNB = (tiffyUsdVal && bnbUSD) ? (tiffyUsdVal / bnbUSD) : null;

Â  Â  Â  modalTiffy.textContent = accumulated + " TIFFY";
Â  Â  Â  modalTiffyUSD.textContent = tiffyUsdVal !== null ? ("$" + tiffyUsdVal.toFixed(2)) : "-";
Â  Â  Â  modalTiffyBNB.textContent = tiffyInBNB !== null ? tiffyInBNB.toFixed(6) + " BNB" : "-";
Â  Â  Â  modalContractFee.textContent = feeBNB.toFixed(6) + " BNB";
Â  Â  Â  modalGasFee.textContent = gasBNB.toFixed(6) + " BNB";
Â  Â  Â  modalTotal.textContent = totalBNB.toFixed(6) + " BNB";
Â  Â  Â  modalUSD.textContent = "$" + ((totalBNB * (bnbUSD || 0)).toFixed(2) || "0.00");
Â  Â  Â  feeModal.style.display = "block";

Â  Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  feeCancel.onclick = ()=> { feeModal.style.display = "none"; resolve(false); };
Â  Â  Â  Â  feeConfirm.onclick = async ()=> {
Â  Â  Â  Â  Â  feeModal.style.display = "none";
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const tx = await contract.methods.claim().send({ from: account, value: fee });
Â  Â  Â  Â  Â  Â  if (tx && tx.status) {
Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(`tiffyClaimed_${account}`, "0");
Â  Â  Â  Â  Â  Â  Â  E.withdrawSound.play();
Â  Â  Â  Â  Â  Â  Â  setupUI();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  alert("âŒ Transaction failed: " + (err && err.message ? err.message : err));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  resolve(true);
Â  Â  Â  Â  };
Â  Â  Â  });
Â  Â  }

Â  Â  function withdraw(){
Â  Â  Â  preConfirmAndSend();
Â  Â  }
Â  })();
Â  </script>
</body>
</html>
