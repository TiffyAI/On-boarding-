<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>TiffyAI Wallet Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <style>
    body {
      margin:0;
      padding:0;
      background:#000;
      color:#0ff;
      font-family:'Segoe UI',sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    .wallet-panel {
      background:rgba(0,0,0,0.7);
      padding:20px;
      border:1px solid #0ff;
      border-radius:12px;
      box-shadow:0 0 25px #0ff;
      text-align:center;
      max-width:400px;
      width:90%;
    }
    .wallet-panel button {
      margin:10px 0;
      padding:12px 25px;
      border:none;
      border-radius:8px;
      font-size:16px;
      cursor:pointer;
      background:linear-gradient(to right,#00f0ff,#4b6cb7);
      color:#fff;
      box-shadow:0 0 15px #0ff;
    }
    #message {
      margin-top:15px;
      font-size:14px;
      color:#fff;
    }
  </style>
</head>
<body>
  <div class="wallet-panel">
    <h2>üåå TiffyAI Wallet</h2>
    <button onclick="connectWallet()">Connect Wallet</button>
    <button onclick="importTiffyToken()">Import TiffyAI Token</button>
    <div id="tokenBalance"></div>
    <div id="message"></div>
  </div>

<script>
const tiffyToken = {
  address: "0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5",
  symbol: "TIFFY",
  decimals: 18,
  image: "https://tiffyai.github.io/Blue-Key-Claim/TiffyAI-Token.png"
};
const tiffyTokenABI = [
  "function balanceOf(address owner) view returns (uint256)"
];

function showMessage(msg) {
  document.getElementById("message").textContent = msg;
}

async function switchToBSC() {
  try {
    await window.ethereum.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: "0x38" }]
    });
  } catch (switchError) {
    if (switchError.code === 4902) {
      await window.ethereum.request({
        method: "wallet_addEthereumChain",
        params: [{
          chainId: "0x38",
          chainName: "BNB Smart Chain",
          rpcUrls: ["https://bsc-dataseed.binance.org/"],
          nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
          blockExplorerUrls: ["https://bscscan.com"]
        }]
      });
    } else {
      throw switchError;
    }
  }
}

async function connectWallet() {
  if (!window.ethereum) {
    showMessage("‚ùå MetaMask is not installed");
    return;
  }
  try {
    await window.ethereum.request({ method: "eth_requestAccounts" });
    await displayBalance();
    showMessage("‚úÖ Wallet connected");
  } catch (err) {
    console.error(err);
    showMessage("‚ùå Connection failed");
  }
}

async function importTiffyToken() {
  if (!window.ethereum) {
    showMessage("‚ùå MetaMask is not installed");
    return;
  }
  try {
    await switchToBSC();
    const wasAdded = await window.ethereum.request({
      method: "wallet_watchAsset",
      params: {
        type: "ERC20",
        options: {
          address: tiffyToken.address,
          symbol: tiffyToken.symbol,
          decimals: tiffyToken.decimals,
          image: tiffyToken.image
        }
      }
    });
    if (wasAdded) {
      showMessage("‚úÖ TiffyAI token added! Check your wallet.");
      await displayBalance();
    } else {
      showMessage("‚ö†Ô∏è Token import cancelled.");
    }
  } catch (err) {
    console.error(err);
    showMessage("‚ùå Error adding token");
  }
}

async function displayBalance() {
  if (!window.ethereum) return;
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const account = await signer.getAddress();
    const tokenContract = new ethers.Contract(tiffyToken.address, tiffyTokenABI, provider);
    const balance = await tokenContract.balanceOf(account);
    const formattedBalance = parseFloat(ethers.utils.formatUnits(balance, tiffyToken.decimals)).toFixed(2);

    // fetch live price from price.json
    let usdPrice = 0;
    try {
      const res = await fetch("/TIFFY-Market-Value/price.json", { cache: "no-store" });
      const data = await res.json();
      usdPrice = parseFloat(data.tiffyToUSD) || 0;
    } catch (e) {
      console.warn("Price fetch failed", e);
    }

    const totalUSD = (formattedBalance * usdPrice).toFixed(2);

    let balanceDisplay = document.getElementById("tokenBalance");
    balanceDisplay.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;justify-content:center;margin-top:15px;">
        <img src="${tiffyToken.image}" alt="TIFFY" style="height:28px;width:28px;">
        <span style="font-size:1.2em;">${formattedBalance} ${tiffyToken.symbol}</span>
        <span style="font-size:1em;color:#00ffc3;">‚Üí $${totalUSD}</span>
      </div>
    `;
  } catch (err) {
    console.error(err);
    showMessage("‚ùå Failed to fetch balance");
  }
}

// auto refresh balance every minute
setInterval(displayBalance, 60000);
</script>
</body>
</html>
